<?xml version="1.0"?>
<simulation>

    <context id="ocn">

      <calendar type="Gregorian" time_origin="2021-01-01" start_date="2021-03"/>

      <!-- Ocean field grid definition -->
      <grid_definition>
        <grid id="grid_2D">
          <domain id="domain" type="rectilinear" ni_glo="10" nj_glo="10">
            <generate_rectilinear_domain/>
          </domain>
        </grid>
      </grid_definition>

      <!-- Accumulate and average on this field --> 
      <field_definition>
        <field id="field2D" grid_ref="grid_2D"  operation="average" read_access="true" expr="@this"/>
      </field_definition>

      <coupler_out_definition>
        <coupler_out context="atm::atm" >

          <!-- Fields sent by ocean are accumulated and averaged on field2D. Result is sent every 4 ts -->
          <field id="field2D_oce_to_atm" field_ref="field2D" freq_op="4ts"/>

          <!-- Restart field to send to atm - No offset, sends are already triggered @ts=1 -->
          <field id="field2D_restart" field_ref="field2D_read" operation="instant" freq_op="1y" detect_missing_value="true"/>

        </coupler_out>
      </coupler_out_definition>

      <!-- Save the outgoing field to file -->
      <file_definition>

        <file id="output_out" name="output_out" output_freq="4ts" type="one_file" enabled="true">
          <field field_ref="field2D_oce_to_atm"  operation="instant" />
        </file>

        <!-- Restart file to READ (No output is done on this file) -->
        <file id="output_restart" name="output_restart" enabled="true" type="one_file" output_freq="1y" mode="read">
          <field id="field2D_read" name="field2D_oce_to_atm" grid_ref="grid_2D" operation="instant" read_access="true"  />
        </file>

      </file_definition>
      <!---->

    </context>


  <context id="atm">

      <calendar type="Gregorian" time_origin="2021-01-01" start_date="2021-03"/>

      <!-- Grid of the incoming ocean field (Same as the one in ocn context) -->
      <grid_definition>
        <grid id="grid_2D">
          <domain id="domain"/>
        </grid>
      </grid_definition>
      

      <!-- Fields coming from ocean -->
      <coupler_in_definition>
        <coupler_in context="ocn::ocn">

          <!-- Receive field every 4 ts, starting @ ts=4 because of offset -->
          <field id="field2D_oce_to_atm" grid_ref="grid_2D" freq_op="4ts" freq_offset="5ts" operation="instant" read_access="true"/>

          <!-- Restart field for atm is provided by ocean - freq_op big so to execute it only one time, offset to run it @ts=1 instead of @ts=0-->
          <field id="field2D_restart" grid_ref="grid_2D" freq_op="1y" freq_offset="1ts" operation="instant" read_access="true"/>

        </coupler_in>
      </coupler_in_definition>


      <!-- Save the incoming field to file if needed -->
      <file_definition>
        <file id="output_in" name="output_in" output_freq="4ts" type="one_file" enabled="true">
          <field field_ref="field2D_oce_to_atm" />
        </file>
      </file_definition>

  </context>

  <!-- XIOS server parameters -->
  <context id="xios">
     <variable_definition>
        <variable_group id="parameters" >
          <variable id="print_file" type="bool">true</variable>
          <!-- <variable id="info_level" type="int">100</variable> -->
          <variable id="transport_protocol" type="string">p2p</variable>
        </variable_group>
     </variable_definition>
  </context>

</simulation>